<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>elphick.mass_composition.mass_composition &mdash; mass-composition  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-binder.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-dataframe.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/sg_gallery-rendered-html.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            mass-composition
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/quickstart.html">Quick Start Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/troubleshooting.html">Troubleshooting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../user_guide/user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html">Example Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../auto_examples/index.html#xarray-gallery">Xarray Gallery</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../datasets/datasets.html">Datasets</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../glossary/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api/modules.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license/license.html">License</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">mass-composition</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">elphick.mass_composition.mass_composition</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for elphick.mass_composition.mass_composition</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objects</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">RegressorMixin</span>

<span class="kn">from</span> <span class="nn">elphick.mass_composition.config</span> <span class="kn">import</span> <span class="n">read_yaml</span>
<span class="kn">from</span> <span class="nn">elphick.mass_composition.mc_status</span> <span class="kn">import</span> <span class="n">Status</span>
<span class="kn">from</span> <span class="nn">elphick.mass_composition.plot</span> <span class="kn">import</span> <span class="n">parallel_plot</span><span class="p">,</span> <span class="n">comparison_plot</span>
<span class="kn">from</span> <span class="nn">elphick.mass_composition.utils</span> <span class="kn">import</span> <span class="n">solve_mass_moisture</span>
<span class="kn">from</span> <span class="nn">elphick.mass_composition.utils.amenability</span> <span class="kn">import</span> <span class="n">amenability_index</span>
<span class="kn">from</span> <span class="nn">elphick.mass_composition.utils.interp</span> <span class="kn">import</span> <span class="n">mass_preserving_interp</span>
<span class="kn">from</span> <span class="nn">elphick.mass_composition.utils.pd_utils</span> <span class="kn">import</span> <span class="n">weight_average</span><span class="p">,</span> <span class="n">calculate_recovery</span><span class="p">,</span> <span class="n">calculate_partition</span>
<span class="kn">from</span> <span class="nn">elphick.mass_composition.utils.sampling</span> <span class="kn">import</span> <span class="n">random_int</span>
<span class="kn">from</span> <span class="nn">elphick.mass_composition.utils.sklearn</span> <span class="kn">import</span> <span class="n">extract_feature_names</span><span class="p">,</span> <span class="n">PandasPipeline</span>

<span class="kn">from</span> <span class="nn">elphick.mass_composition.variables</span> <span class="kn">import</span> <span class="n">Variables</span><span class="p">,</span> <span class="n">VariableGroups</span>


<div class="viewcode-block" id="MassComposition"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition">[docs]</a><span class="k">class</span> <span class="nc">MassComposition</span><span class="p">:</span>

<div class="viewcode-block" id="MassComposition.__init__"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">mass_wet_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">mass_dry_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">moisture_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">chem_vars</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">mass_units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">composition_units</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">config_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            data:</span>
<span class="sd">            name:</span>
<span class="sd">            mass_wet_var:</span>
<span class="sd">            mass_dry_var:</span>
<span class="sd">            moisture_var:</span>
<span class="sd">            chem_vars:</span>
<span class="sd">            mass_units:</span>
<span class="sd">            constraints:</span>
<span class="sd">            config_file:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">config_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s1">&#39;./config/mc_config.yml&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">read_yaml</span><span class="p">(</span><span class="n">config_file</span><span class="p">)</span>

        <span class="c1"># _nodes can preserve relationships from math operations, and can be used to build a network.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">random_int</span><span class="p">(),</span> <span class="n">random_int</span><span class="p">()]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mass_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">mass_units</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_composition_units</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;units&#39;</span><span class="p">][</span><span class="s1">&#39;composition_rel&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">composition_units</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_specified_columns</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mass_wet_var&#39;</span><span class="p">:</span> <span class="n">mass_wet_var</span><span class="p">,</span>
                                         <span class="s1">&#39;mass_dry_var&#39;</span><span class="p">:</span> <span class="n">mass_dry_var</span><span class="p">,</span>
                                         <span class="s1">&#39;moisture_var&#39;</span><span class="p">:</span> <span class="n">moisture_var</span><span class="p">,</span>
                                         <span class="s1">&#39;chem_vars&#39;</span><span class="p">:</span> <span class="n">chem_vars</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Variables</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Status</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>  <span class="c1"># preserve the incoming data variable.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_strip_common_prefix</span><span class="p">(</span><span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
        <span class="c1"># Extract prefixes</span>
        <span class="n">common_prefix</span> <span class="o">=</span> <span class="n">MassComposition</span><span class="o">.</span><span class="n">get_common_prefix</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">df</span>
        <span class="c1"># Create a copy of the dataframe and strip the most common prefix from column names</span>
        <span class="k">if</span> <span class="n">common_prefix</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">res</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">common_prefix</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">common_prefix</span><span class="p">)</span> <span class="k">else</span> <span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
                           <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">common_prefix</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_common_prefix</span><span class="p">(</span><span class="n">columns</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">prefixes</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
        <span class="c1"># Count the frequency of each prefix</span>
        <span class="n">prefix_counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">prefixes</span><span class="p">)</span>
        <span class="c1"># Check if prefix_counter is not empty</span>
        <span class="k">if</span> <span class="n">prefix_counter</span><span class="p">:</span>
            <span class="c1"># Find the most common prefix</span>
            <span class="n">common_prefix</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">prefix_counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="c1"># Only return the prefix if its frequency is 3 or more</span>
            <span class="k">if</span> <span class="n">freq</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">common_prefix</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">set_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">],</span>
                 <span class="n">constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
            <span class="c1"># we assume it is a compliant mc-xarray</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">Variables</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">],</span>
                                       <span class="n">supplied</span><span class="o">=</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">variables</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">],</span>
                                       <span class="n">specified_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_specified_columns</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>

            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;The data has duplicate indexes.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="p">)</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">nlevels</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;The data has more than 2 levels in the index, which can consume excessive &#39;</span>
                                     <span class="s1">&#39;memory for large datasets.  Is this is what you intend?  Depending on your&#39;</span>
                                     <span class="s1">&#39;requirements you may be able to process ths dataset with a single index.&#39;</span><span class="p">)</span>

            <span class="c1"># seek a prefix to self assign the name</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">common_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_strip_common_prefix</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">common_prefix</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_specified_columns</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">common_prefix</span><span class="si">}</span><span class="s2">_&quot;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_specified_columns</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                           <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="n">Variables</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">],</span>
                                       <span class="n">supplied</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span>
                                       <span class="n">specified_map</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_specified_columns</span><span class="p">)</span>

            <span class="c1"># if interval pairs are passed as indexes then create the proper interval index</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_interval_indexes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>

            <span class="c1"># rename the columns using the Variables class</span>
            <span class="n">data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">vars</span><span class="o">.</span><span class="n">col_to_var</span><span class="p">(),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># solve or validate the moisture balance</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_solve_mass_moisture</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">xr_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dataframe_to_mc_dataset</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">xr_ds</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;unnamed&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">common_prefix</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">common_prefix</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">)</span>

        <span class="c1"># explicitly define the constraints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_constraint_bounds</span><span class="p">(</span><span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_constraints</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_constraint_bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraints</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">]:</span>
        <span class="n">d_constraints</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># populate from the defaults</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">mass_moisture</span><span class="o">.</span><span class="n">get_var_names</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;mass&#39;</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">d_constraints</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">][</span><span class="s1">&#39;mass&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">d_constraints</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">][</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">chemistry</span><span class="o">.</span><span class="n">get_var_names</span><span class="p">():</span>
            <span class="n">d_constraints</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;constraints&#39;</span><span class="p">][</span><span class="s1">&#39;composition&#39;</span><span class="p">]</span>

        <span class="c1"># modify the default dict based on any user passed constraints</span>
        <span class="k">if</span> <span class="n">constraints</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">d_constraints</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

        <span class="k">return</span> <span class="n">d_constraints</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_xarray</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;unnamed&#39;</span><span class="p">):</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">ds</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">data</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>

        <span class="n">moisture</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;mass_wet&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;mass_dry&#39;</span><span class="p">])</span> <span class="o">/</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="s1">&#39;mass_wet&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;H2O&#39;</span><span class="p">,</span>
                                              <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="s1">&#39;%&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39;H2O&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;mc_type&#39;</span><span class="p">:</span> <span class="s1">&#39;moisture&#39;</span><span class="p">,</span>
                                                     <span class="s1">&#39;mc_col_orig&#39;</span><span class="p">:</span> <span class="s1">&#39;H2O&#39;</span><span class="p">}</span>
                                              <span class="p">)</span>

        <span class="n">data</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mc_vars_mass&#39;</span><span class="p">]],</span>
             <span class="n">moisture</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mc_vars_chem&#39;</span><span class="p">]],</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mc_vars_attrs&#39;</span><span class="p">]]])</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">update_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">values</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">]):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">):</span>
            <span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span><span class="p">[</span><span class="n">v</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">Status</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_check_constraints</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">set_parent_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">set_child_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">child</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">child</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">set_stream_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="k">return</span> <span class="bp">self</span>

<div class="viewcode-block" id="MassComposition.to_xarray"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.to_xarray">[docs]</a>    <span class="k">def</span> <span class="nf">to_xarray</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the mc compliant xr.Dataset</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span></div>

<div class="viewcode-block" id="MassComposition.aggregate"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.aggregate">[docs]</a>    <span class="k">def</span> <span class="nf">aggregate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_var</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">group_bins</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">as_dataframe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">original_column_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the weight average.</span>

<span class="sd">        Args:</span>
<span class="sd">            group_var: Optional grouping variable</span>
<span class="sd">            group_bins: Optional bins to apply to the group_var</span>
<span class="sd">            as_dataframe: If True return a pd.DataFrame</span>
<span class="sd">            original_column_names: If True, and as_dataframe is True, will return with the original column names.</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">group_var</span><span class="o">=</span><span class="n">group_var</span><span class="p">,</span>
                                                  <span class="n">group_bins</span><span class="o">=</span><span class="n">group_bins</span><span class="p">,</span>
                                                  <span class="n">as_dataframe</span><span class="o">=</span><span class="n">as_dataframe</span><span class="p">,</span>
                                                  <span class="n">original_column_names</span><span class="o">=</span><span class="n">original_column_names</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="k">def</span> <span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">queries</span><span class="o">=</span><span class="n">queries</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="MassComposition.constrain"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.constrain">[docs]</a>    <span class="k">def</span> <span class="nf">constrain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">clip_mass</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">clip_composition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">relative_mass</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">relative_composition</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                  <span class="n">other</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;MassComposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Constrain the mass-composition</span>

<span class="sd">        It is possible that a MassComposition object is created from a source that has improbable results.</span>
<span class="sd">        In this case this method can help improve the integrity of the mass-composition.</span>

<span class="sd">        Args:</span>
<span class="sd">            clip_mass: Limit the minimum and maximum values of the mass between a minimum and maximum absolute value.</span>
<span class="sd">            clip_composition: Limit the minimum and maximum values of the composition between a minimum and</span>
<span class="sd">                maximum absolute value.</span>
<span class="sd">            relative_mass: Constrain the mass recovery of the object to the other object</span>
<span class="sd">            relative_composition: Constrain the component recovery of the object to the other object</span>
<span class="sd">            other: The other object used for recovery calculation.  Must be provided if relative_mass or</span>
<span class="sd">            relative_composition are provided.</span>



<span class="sd">        Returns:</span>
<span class="sd">            Returns the new object constrained per the provided arguments.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xr_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">clip_mass</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clip_mass</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clip_mass</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">xr_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">(</span><span class="n">xr_ds</span><span class="o">=</span><span class="n">xr_ds</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">limits</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xr_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">(</span><span class="n">xr_ds</span><span class="o">=</span><span class="n">xr_ds</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">xr_ds</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_mass</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">clip_mass</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">clip_composition</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">clip_composition</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">clip_composition</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">xr_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">(</span><span class="n">xr_ds</span><span class="o">=</span><span class="n">xr_ds</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">limits</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xr_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">(</span><span class="n">xr_ds</span><span class="o">=</span><span class="n">xr_ds</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">xr_ds</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_chem</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">clip_composition</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">relative_mass</span> <span class="ow">or</span> <span class="n">relative_composition</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">object</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The other other argument must be provided to apply relative constraints.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">relative_mass</span><span class="p">:</span>
            <span class="n">xr_relative</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">xr_ds</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_mass</span><span class="p">]</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">xr_ds</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_mass</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relative_mass</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">relative_mass</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">xr_relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">(</span><span class="n">xr_ds</span><span class="o">=</span><span class="n">xr_relative</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">limits</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xr_relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">(</span><span class="n">xr_ds</span><span class="o">=</span><span class="n">xr_relative</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="n">xr_ds</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_mass</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="n">relative_mass</span><span class="p">)</span>

            <span class="c1"># convert back to relative composition (mass/grades)</span>
            <span class="n">xr_ds</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">xr_ds</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_mass</span><span class="p">]</span> <span class="o">*</span> <span class="n">xr_relative</span>
            <span class="n">xr_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">xr_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_chem</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_attrs</span><span class="p">]])</span>
            <span class="n">xr_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_all_attrs</span><span class="p">(</span><span class="n">xr_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">relative_composition</span><span class="p">:</span>
            <span class="n">xr_relative</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">other</span><span class="p">,</span> <span class="n">comparisons</span><span class="o">=</span><span class="s1">&#39;recovery&#39;</span><span class="p">,</span> <span class="n">explicit_names</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                   <span class="n">as_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">relative_composition</span><span class="p">,</span> <span class="n">Dict</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">relative_composition</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">xr_relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">(</span><span class="n">xr_ds</span><span class="o">=</span><span class="n">xr_relative</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">limits</span><span class="o">=</span><span class="n">v</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xr_relative</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip</span><span class="p">(</span><span class="n">xr_ds</span><span class="o">=</span><span class="n">xr_relative</span><span class="p">,</span> <span class="n">variables</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_chem</span><span class="p">,</span>
                                         <span class="n">limits</span><span class="o">=</span><span class="n">relative_composition</span><span class="p">)</span>

            <span class="c1"># convert back to relative composition (mass/grades)</span>
            <span class="n">xr_ds</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">xr_relative</span><span class="p">)</span>
            <span class="n">xr_ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">([</span><span class="n">xr_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_attrs</span><span class="p">]])</span>
            <span class="n">xr_ds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_copy_all_attrs</span><span class="p">(</span><span class="n">xr_ds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="n">MassComposition</span><span class="p">()</span><span class="o">.</span><span class="n">from_xarray</span><span class="p">(</span><span class="n">xr_ds</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">,</span> <span class="n">comparisons</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s1">&#39;recovery&#39;</span><span class="p">,</span>
                <span class="n">explicit_names</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">as_dataframe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]:</span>

        <span class="n">comparisons</span> <span class="o">=</span> <span class="p">[</span><span class="n">comparisons</span><span class="p">]</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">comparisons</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">comparisons</span>
        <span class="n">valid_comparisons</span><span class="p">:</span> <span class="n">Set</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;recovery&#39;</span><span class="p">,</span> <span class="s1">&#39;difference&#39;</span><span class="p">,</span> <span class="s1">&#39;divide&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">}</span>

        <span class="k">def</span> <span class="nf">set_explicit_names</span><span class="p">(</span><span class="n">xrds</span><span class="p">,</span> <span class="n">comparison</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
            <span class="n">xrds</span> <span class="o">=</span> <span class="n">xrds</span><span class="o">.</span><span class="n">rename_vars</span><span class="p">(</span>
                <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;comparisons&#39;</span><span class="p">][</span><span class="n">comparison</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span>
                 <span class="n">xrds</span><span class="o">.</span><span class="n">data_vars</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">xrds</span>

        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">data_vars</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">mc_vars_attrs</span><span class="p">]</span>

        <span class="n">chunks</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;recovery&#39;</span> <span class="ow">in</span> <span class="n">comparisons</span> <span class="ow">or</span> <span class="n">comparisons</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">composition_to_mass</span><span class="p">()[</span><span class="n">cols</span><span class="p">]</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">composition_to_mass</span><span class="p">()[</span><span class="n">cols</span><span class="p">]</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">set_explicit_names</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">comparison</span><span class="o">=</span><span class="s1">&#39;recovery&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">explicit_names</span> <span class="k">else</span> <span class="n">ds</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;difference&#39;</span> <span class="ow">in</span> <span class="n">comparisons</span> <span class="ow">or</span> <span class="n">comparisons</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">set_explicit_names</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">comparison</span><span class="o">=</span><span class="s1">&#39;difference&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">explicit_names</span> <span class="k">else</span> <span class="n">ds</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;divide&#39;</span> <span class="ow">in</span> <span class="n">comparisons</span> <span class="ow">or</span> <span class="n">comparisons</span> <span class="o">==</span> <span class="p">[</span><span class="s1">&#39;all&#39;</span><span class="p">]:</span>
            <span class="n">ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span>
            <span class="n">ds</span> <span class="o">=</span> <span class="n">set_explicit_names</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">comparison</span><span class="o">=</span><span class="s1">&#39;divide&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">explicit_names</span> <span class="k">else</span> <span class="n">ds</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">chunks</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The comparison argument is not valid: </span><span class="si">{</span><span class="n">valid_comparisons</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">chunks</span><span class="p">)</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span> <span class="k">if</span> <span class="n">as_dataframe</span> <span class="k">else</span> <span class="n">res</span>

        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="MassComposition.binned_mass_composition"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.binned_mass_composition">[docs]</a>    <span class="k">def</span> <span class="nf">binned_mass_composition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                <span class="n">bin_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">cumulative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;descending&#39;</span><span class="p">,</span>
                                <span class="n">as_dataframe</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;A.K.A &quot;The Grade-Tonnage&quot; curve.</span>

<span class="sd">        Mass and grade by bins for a cut-off variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            cutoff_var: The variable that defines the bins</span>
<span class="sd">            bin_width: The width of the bin</span>
<span class="sd">            cumulative: If True, the results are cumulative weight averaged.</span>
<span class="sd">            direction: &#39;ascending&#39;|&#39;descending&#39;, if cumulative is True, the direction of accumulation</span>
<span class="sd">            as_dataframe: If True return a pd.DataFrame</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">cutoff_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">variables</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">cutoff_var</span><span class="si">}</span><span class="s1"> is not found in the data&#39;</span><span class="p">)</span>

        <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">cutoff_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)),</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">cutoff_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">+</span> <span class="n">bin_width</span><span class="p">,</span>
                         <span class="n">bin_width</span><span class="p">)</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">group_var</span><span class="o">=</span><span class="n">cutoff_var</span><span class="p">,</span> <span class="n">group_bins</span><span class="o">=</span><span class="n">bins</span><span class="p">,</span> <span class="n">as_dataframe</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cumulative</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">cumulate</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">as_dataframe</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">data</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="MassComposition.ideal_incremental_separation"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.ideal_incremental_separation">[docs]</a>    <span class="k">def</span> <span class="nf">ideal_incremental_separation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discard_from</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;lowest&quot;</span><span class="p">,</span> <span class="s2">&quot;highest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lowest&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incrementally separate a fractionated sample.</span>

<span class="sd">        This method sorts by the provided direction prior to incrementally removing and discarding the first fraction</span>
<span class="sd">         (of the remaining fractions) and recalculating the mass-composition and recovery of the portion remaining.</span>
<span class="sd">         This is equivalent to incrementally applying a perfect separation (partition) at every interval edge.</span>

<span class="sd">        This method is only applicable to a 1D object where the single dimension is a pd.Interval type.</span>

<span class="sd">        See also: ideal_incremental_composition, ideal_incremental_recovery.</span>

<span class="sd">        Args:</span>
<span class="sd">            discard_from: Defines the discarded direction.  discard_from = &quot;lowest&quot; will discard the lowest value</span>
<span class="sd">             first, then the next lowest, etc.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A pandas DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_one_dim_interval</span><span class="p">()</span>

        <span class="n">sample</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

        <span class="n">is_decreasing</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_monotonic_decreasing</span>
        <span class="k">if</span> <span class="n">discard_from</span> <span class="o">==</span> <span class="s2">&quot;lowest&quot;</span><span class="p">:</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sample</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">new_index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Index</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
        <span class="n">new_index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_cut-point&quot;</span>

        <span class="n">aggregated_chunks</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">recovery_chunks</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">head</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">weight_average</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">indx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="n">tmp_composition</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">sample</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">i</span><span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">weight_average</span><span class="p">)</span>
            <span class="n">aggregated_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_composition</span><span class="p">)</span>
            <span class="n">recovery_chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp_composition</span><span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">calculate_recovery</span><span class="p">,</span> <span class="n">df_ref</span><span class="o">=</span><span class="n">head</span><span class="p">))</span>

        <span class="n">res_composition</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">aggregated_chunks</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;composition&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="n">new_index</span><span class="p">)</span>
        <span class="n">res_recovery</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">recovery_chunks</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">attribute</span><span class="o">=</span><span class="s2">&quot;recovery&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="n">new_index</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">is_decreasing</span><span class="p">:</span>
            <span class="n">res_composition</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">res_recovery</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">res_composition</span><span class="p">,</span> <span class="n">res_recovery</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span>
            <span class="p">[</span><span class="n">new_index</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;attribute&#39;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="MassComposition.ideal_incremental_composition"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.ideal_incremental_composition">[docs]</a>    <span class="k">def</span> <span class="nf">ideal_incremental_composition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discard_from</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;lowest&quot;</span><span class="p">,</span> <span class="s2">&quot;highest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lowest&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incrementally separate a fractionated sample.</span>

<span class="sd">        This method sorts by the provided direction prior to incrementally removing and discarding the first fraction</span>
<span class="sd">         (of the remaining fractions) and recalculating the mass-composition of the portion remaining.</span>
<span class="sd">         This is equivalent to incrementally applying a perfect separation (partition) at every interval edge.</span>

<span class="sd">        This method is only applicable to a 1D object where the single dimension is a pd.Interval type.</span>

<span class="sd">        See also: ideal_incremental_separation, ideal_incremental_recovery.</span>

<span class="sd">        Args:</span>
<span class="sd">            discard_from: Defines the discarded direction.  discard_from = &quot;lowest&quot; will discard the lowest value</span>
<span class="sd">             first, then the next lowest, etc.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A pandas DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideal_incremental_separation</span><span class="p">(</span><span class="n">discard_from</span><span class="o">=</span><span class="n">discard_from</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="s1">&#39;attribute==&quot;composition&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;attribute&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="MassComposition.ideal_incremental_recovery"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.ideal_incremental_recovery">[docs]</a>    <span class="k">def</span> <span class="nf">ideal_incremental_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">discard_from</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;lowest&quot;</span><span class="p">,</span> <span class="s2">&quot;highest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lowest&quot;</span><span class="p">,</span>
                                   <span class="n">apply_closure</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Incrementally separate a fractionated sample.</span>

<span class="sd">        This method sorts by the provided direction prior to incrementally removing and discarding the first fraction</span>
<span class="sd">         (of the remaining fractions) and recalculating the recovery of the portion remaining.</span>
<span class="sd">         This is equivalent to incrementally applying a perfect separation (partition) at every interval edge.</span>

<span class="sd">        This method is only applicable to a 1D object where the single dimension is a pd.Interval type.</span>

<span class="sd">        See also: ideal_incremental_separation, ideal_incremental_composition.</span>

<span class="sd">        Args:</span>
<span class="sd">            discard_from: Defines the discarded direction.  discard_from = &quot;lowest&quot; will discard the lowest value</span>
<span class="sd">             first, then the next lowest, etc.</span>
<span class="sd">            apply_closure: If True, Add the missing record (zero recovery) that closes the recovery envelope.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A pandas DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideal_incremental_separation</span><span class="p">(</span><span class="n">discard_from</span><span class="o">=</span><span class="n">discard_from</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="s1">&#39;attribute==&quot;recovery&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;attribute&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mass_dry&#39;</span><span class="p">:</span> <span class="s1">&#39;mass&#39;</span><span class="p">})</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mass_wet&quot;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">apply_closure</span><span class="p">:</span>
            <span class="c1"># add zero recovery record to close the envelope.</span>
            <span class="n">indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">==</span> <span class="mf">0.0</span> <span class="k">else</span> <span class="mf">0.0</span>
            <span class="n">indx_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">indx</span><span class="p">)</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">])</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">indx_name</span>
        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="MassComposition.split"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">fraction</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
              <span class="n">name_1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">name_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;MassComposition&#39;</span><span class="p">,</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split the object by mass</span>

<span class="sd">        A simple mass split maintaining the same composition</span>

<span class="sd">        See also: split_by_partition, split_by_function, split_by_estimator</span>

<span class="sd">        Args:</span>
<span class="sd">            fraction: A constant in the range [0.0, 1.0]</span>
<span class="sd">            name_1: The name of the reference stream created by the split</span>
<span class="sd">            name_2: The name of the complement stream created by the split</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple of two datasets, the first with the mass fraction specified, the other the complement</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xr_ds_1</span><span class="p">,</span> <span class="n">xr_ds_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="n">fraction</span><span class="p">)</span>

        <span class="n">out</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="n">MassComposition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">xr_ds_1</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">xr_ds_1</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">comp</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="n">MassComposition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">xr_ds_2</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">xr_ds_2</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_post_process_split</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">name_1</span><span class="p">,</span> <span class="n">name_2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">comp</span></div>

<div class="viewcode-block" id="MassComposition.split_by_partition"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.split_by_partition">[docs]</a>    <span class="k">def</span> <span class="nf">split_by_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">partition_definition</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
                           <span class="n">name_1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">name_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;MassComposition&#39;</span><span class="p">,</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Partition the object along a given dimension.</span>

<span class="sd">        This method applies the defined separation resulting in two new objects.</span>

<span class="sd">        See also: split, split_by_function, split_by_estimator</span>

<span class="sd">        Args:</span>
<span class="sd">            partition_definition: A partition function that defines the efficiency of separation along a dimension</span>
<span class="sd">            name_1: The name of the reference stream created by the split</span>
<span class="sd">            name_2: The name of the complement stream created by the split</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple of two datasets, the first with the mass fraction specified, the other the complement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">comp</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">xr_ds_1</span><span class="p">,</span> <span class="n">xr_ds_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">split_by_partition</span><span class="p">(</span><span class="n">partition_definition</span><span class="o">=</span><span class="n">partition_definition</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">xr_ds_1</span>
        <span class="n">comp</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="n">xr_ds_2</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_post_process_split</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">name_1</span><span class="p">,</span> <span class="n">name_2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">comp</span></div>

<div class="viewcode-block" id="MassComposition.split_by_function"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.split_by_function">[docs]</a>    <span class="k">def</span> <span class="nf">split_by_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                          <span class="n">split_function</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span>
                          <span class="n">name_1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                          <span class="n">name_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;MassComposition&#39;</span><span class="p">,</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split an object using a function.</span>

<span class="sd">        This method applies the function to self, resulting in two new objects. The object returned with name_1</span>
<span class="sd">        is the result of the function.  The object returned with name_2 is the complement.</span>

<span class="sd">        See also: split, split_by_estimator, split_by_partition</span>

<span class="sd">        Args:</span>
<span class="sd">            split_function: Any function that transforms the dataframe from a MassComposition object into a new</span>
<span class="sd">             dataframe with values representing a new (output) stream.  The returned dataframe structure must be</span>
<span class="sd">             identical to the input dataframe.</span>
<span class="sd">            name_1: The name of the stream created by the function</span>
<span class="sd">            name_2: The name of the complement stream created by the split, which is calculated automatically.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple of two datasets, the first with the mass fraction specified, the other the complement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">split_function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">())</span>
        <span class="n">out</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="n">MassComposition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name_1</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">out_data</span><span class="p">)</span>
        <span class="n">comp</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name_2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_post_process_split</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">name_1</span><span class="p">,</span> <span class="n">name_2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">comp</span></div>

<div class="viewcode-block" id="MassComposition.split_by_estimator"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.split_by_estimator">[docs]</a>    <span class="k">def</span> <span class="nf">split_by_estimator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">estimator</span><span class="p">:</span> <span class="n">PandasPipeline</span><span class="p">,</span>
                           <span class="n">name_1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">name_2</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">extra_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">allow_prefix_mismatch</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                           <span class="n">mass_recovery_column</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">mass_recovery_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="s1">&#39;MassComposition&#39;</span><span class="p">,</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Split an object using a sklearn estimator.</span>

<span class="sd">        This method applies the function to self, resulting in two new objects. The object returned with name_1</span>
<span class="sd">        is the result of the estimator.predict() method.  The object returned with name_2 is the complement.</span>

<span class="sd">        See also: split, split_by_function, split_by_partition</span>

<span class="sd">        Args:</span>
<span class="sd">            estimator: Any sklearn estimator that transforms the dataframe from a MassComposition object into a new</span>
<span class="sd">             dataframe with values representing a new (output) stream using the predict method.  The returned</span>
<span class="sd">             dataframe structure must be identical to the input dataframe.</span>
<span class="sd">            name_1: The name of the stream created by the estimator.</span>
<span class="sd">            name_2: The name of the complement stream created by the split, which is calculated automatically.</span>
<span class="sd">            extra_features: Optional additional features to pass to the estimator as features.</span>
<span class="sd">            allow_prefix_mismatch: If True, allow feature names to be different and log an info message. If False,</span>
<span class="sd">             raise an error when feature names are different.</span>
<span class="sd">            mass_recovery_column: If provided, this indicates that the model has estimated mass recovery, not mass</span>
<span class="sd">             explicitly.  This will execute a transformation of the predicted `dry` mass recovery to dry mass.</span>
<span class="sd">            mass_recovery_max: The maximum mass recovery value, used to scale the mass recovery to mass.  Only</span>
<span class="sd">             applicable if mass_recovery_column is provided.  Should be either 1.0 or 100.0.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple of two MassComposition objects, the first the output of the estimator, the other the complement</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Extract feature names from the estimator, and get the actual features</span>
        <span class="n">feature_names</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">extract_feature_names</span><span class="p">(</span><span class="n">estimator</span><span class="p">))</span>
        <span class="n">features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_features</span><span class="p">(</span><span class="n">feature_names</span><span class="p">,</span> <span class="n">allow_prefix_mismatch</span><span class="o">=</span><span class="n">allow_prefix_mismatch</span><span class="p">,</span>
                                                    <span class="n">extra_features</span><span class="o">=</span><span class="n">extra_features</span><span class="p">)</span>

        <span class="c1"># Apply the estimator</span>
        <span class="n">estimates</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">estimator</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">features</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">estimates</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;The estimator must return a DataFrame&quot;</span><span class="p">)</span>

        <span class="c1"># Detect a possible prefix from the estimate columns</span>
        <span class="n">features_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_prefix</span><span class="p">(</span><span class="n">features</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>
        <span class="n">estimates_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_prefix</span><span class="p">(</span><span class="n">estimates</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">())</span>

        <span class="c1"># If there is a prefix, check that it matches name_1, subject to allow_prefix_mismatch</span>
        <span class="k">if</span> <span class="n">estimates_prefix</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_prefix_mismatch</span> <span class="ow">and</span> <span class="n">name_1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">name_1</span> <span class="o">==</span> <span class="n">estimates_prefix</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Common prefix mismatch: </span><span class="si">{</span><span class="n">features_prefix</span><span class="si">}</span><span class="s2"> and name_1: </span><span class="si">{</span><span class="n">name_1</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># assign the output names, based on specified names, allow for prefix mismatch</span>
        <span class="n">name_1</span> <span class="o">=</span> <span class="n">name_1</span> <span class="k">if</span> <span class="n">name_1</span> <span class="k">else</span> <span class="n">estimates_prefix</span>

        <span class="k">if</span> <span class="n">mass_recovery_column</span><span class="p">:</span>
            <span class="c1"># Transform the mass recovery to mass by applying the mass recovery to the dry mass of the input stream</span>
            <span class="k">if</span> <span class="n">mass_recovery_max</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mass_recovery_max must be either 1.0 or 100.0, not </span><span class="si">{</span><span class="n">mass_recovery_max</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">mass_recovery_column</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">estimates</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;mass_recovery_column: </span><span class="si">{</span><span class="n">mass_recovery_column</span><span class="si">}</span><span class="s2"> not found in the estimates.&quot;</span><span class="p">)</span>

            <span class="n">dry_mass_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mass_dry</span><span class="o">.</span><span class="n">name</span>
            <span class="n">estimates</span><span class="p">[</span><span class="n">mass_recovery_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">estimates</span><span class="p">[</span><span class="n">mass_recovery_column</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span>
                <span class="n">dry_mass_var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="n">mass_recovery_max</span>
            <span class="n">estimates</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">mass_recovery_column</span><span class="p">:</span> <span class="n">dry_mass_var</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">estimates_prefix</span><span class="p">:</span>
            <span class="n">col_name_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">estimates_prefix</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">estimates</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>
            <span class="n">estimates</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">col_name_map</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">out</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="n">MassComposition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name_1</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">estimates</span><span class="p">)</span>
        <span class="n">comp</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">other</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name_2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_post_process_split</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">comp</span><span class="p">,</span> <span class="n">name_1</span><span class="p">,</span> <span class="n">name_2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span><span class="p">,</span> <span class="n">comp</span></div>

    <span class="k">def</span> <span class="nf">_get_features</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">feature_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">allow_prefix_mismatch</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
                      <span class="n">extra_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method checks if the feature names required by an estimator are present in the data. If not, it tries to</span>
<span class="sd">        match the feature names by considering a common prefix. If a match is found, the columns in the data are renamed</span>
<span class="sd">        accordingly. If a match is not found and `allow_prefix_mismatch` is False, an error is raised. If</span>
<span class="sd">        `allow_prefix_mismatch` is True, the method proceeds with the mismatched feature names.</span>

<span class="sd">        If `extra_features` is provided, these features are added to the data.</span>

<span class="sd">        Args:</span>
<span class="sd">            feature_names (List[str]): A list of feature names required by the estimator.</span>
<span class="sd">            allow_prefix_mismatch (bool): If True, allows the feature names in the data and the estimator to be different.</span>
<span class="sd">            extra_features (Optional[pd.DataFrame]): Additional features to be added to the data.</span>

<span class="sd">        Returns:</span>
<span class="sd">            pd.DataFrame: The data with the correct feature names.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If `allow_prefix_mismatch` is False and the feature names in the data and the estimator do not match.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create a mapping of lower-case feature names to original feature names</span>
        <span class="n">feature_name_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">}</span>

        <span class="n">df_features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">extra_features</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">df_features</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_features</span><span class="p">,</span> <span class="n">extra_features</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">missing_features</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_features</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">missing_features</span><span class="p">:</span>
            <span class="n">prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">_&quot;</span>
            <span class="n">common_prefix</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_common_prefix</span><span class="p">(</span><span class="n">feature_names</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">common_prefix</span> <span class="ow">and</span> <span class="n">common_prefix</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">!=</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="n">allow_prefix_mismatch</span><span class="p">:</span>
                <span class="n">prefix</span> <span class="o">=</span> <span class="n">common_prefix</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span>

            <span class="c1"># create a map to support renaming the columns</span>
            <span class="n">prefixed_feature_map</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="p">:</span> <span class="n">feature_name_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span>
                                                    <span class="n">df_features</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span>
                                                    <span class="n">feature_name_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">prefix</span><span class="si">}{</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
            <span class="n">df_features</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">prefixed_feature_map</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">missing_features</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">feature_names</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">df_features</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">missing_features</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Missing features: </span><span class="si">{</span><span class="n">missing_features</span><span class="si">}</span><span class="s2">, with mc.name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, prefix: </span><span class="si">{</span><span class="n">prefix</span><span class="si">}</span><span class="s2">&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot; and allow_prefix_mismatch set to </span><span class="si">{</span><span class="n">allow_prefix_mismatch</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="c1"># Return the dataframe with the selected features</span>
        <span class="n">df_features</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">df_features</span><span class="p">[</span><span class="n">feature_names</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df_features</span>

<div class="viewcode-block" id="MassComposition.calculate_partition"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.calculate_partition">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the partition of the ref stream relative to self&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_one_dim_interval</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">calculate_partition</span><span class="p">(</span><span class="n">df_feed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(),</span> <span class="n">df_ref</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(),</span>
                                   <span class="n">col_mass_dry</span><span class="o">=</span><span class="s1">&#39;mass_dry&#39;</span><span class="p">)</span></div>

    <span class="c1"># def resample(self, dim: str, num_intervals: int = 50, edge_precision: int = 8) -&gt; &#39;MassComposition&#39;:</span>
    <span class="c1">#     res = deepcopy(self)</span>
    <span class="c1">#     res._data = self._data.mc.resample(dim=dim, num_intervals=num_intervals, edge_precision=edge_precision)</span>
    <span class="c1">#     return res</span>

<div class="viewcode-block" id="MassComposition.resample_1d"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.resample_1d">[docs]</a>    <span class="k">def</span> <span class="nf">resample_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_edges</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Iterable</span><span class="p">,</span> <span class="nb">int</span><span class="p">],</span>
                    <span class="n">precision</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">include_original_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resample a 1D fractional dim/index</span>

<span class="sd">        Args:</span>
<span class="sd">            interval_edges: The values of the new grid (interval edges).  If an int, will up-sample by that factor, for</span>
<span class="sd">             example the value of 10 will automatically define edges that create 10 x the resolution (up-sampled).</span>
<span class="sd">            precision: Optional integer for the number of decimal places to round the grid values to.</span>
<span class="sd">            include_original_edges: If True include the original edges in the grid.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A new object interpolated onto the new grid</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: add support for supplementary variables</span>

        <span class="n">df_upsampled</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">mass_preserving_interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">(),</span>
                                                            <span class="n">interval_edges</span><span class="o">=</span><span class="n">interval_edges</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="n">precision</span><span class="p">,</span>
                                                            <span class="n">include_original_edges</span><span class="o">=</span><span class="n">include_original_edges</span><span class="p">)</span>

        <span class="n">obj</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="n">MassComposition</span><span class="p">(</span><span class="n">df_upsampled</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span>
        <span class="k">return</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="MassComposition.add"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.add">[docs]</a>    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add two objects</span>

<span class="sd">        Adds other to self, with optional name of the returned object</span>
<span class="sd">        Args:</span>
<span class="sd">            other: object to add to self</span>
<span class="sd">            name: name of the returned object</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__add__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="MassComposition.sub"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.sub">[docs]</a>    <span class="k">def</span> <span class="nf">sub</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtract two objects</span>

<span class="sd">        Subtracts other from self, with optional name of the returned object</span>
<span class="sd">        Args:</span>
<span class="sd">            other: object to subtract from self</span>
<span class="sd">            name: name of the returned object</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__sub__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="MassComposition.div"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.div">[docs]</a>    <span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Divide two objects</span>

<span class="sd">        Divides self by other, with optional name of the returned object</span>
<span class="sd">        Args:</span>
<span class="sd">            other: the denominator (or reference) object</span>
<span class="sd">            name: name of the returned object</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__truediv__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">res</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="MassComposition.plot_bins"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.plot_bins">[docs]</a>    <span class="k">def</span> <span class="nf">plot_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                  <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                  <span class="n">cutoff_var</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                  <span class="n">bin_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                  <span class="n">cumulative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                  <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;descending&#39;</span><span class="p">,</span>
                  <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot &quot;The Grade-Tonnage&quot; curve.</span>

<span class="sd">        Mass and grade by bins for a cut-off variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            variables: List of variables to include in the plot</span>
<span class="sd">            cutoff_var: The variable that defines the bins</span>
<span class="sd">            bin_width: The width of the bin</span>
<span class="sd">            cumulative: If True, the results are cumulative weight averaged.</span>
<span class="sd">            direction: &#39;ascending&#39;|&#39;descending&#39;, if cumulative is True, the direction of accumulation</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bin_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">binned_mass_composition</span><span class="p">(</span><span class="n">cutoff_var</span><span class="o">=</span><span class="n">cutoff_var</span><span class="p">,</span>
                                                              <span class="n">bin_width</span><span class="o">=</span><span class="n">bin_width</span><span class="p">,</span>
                                                              <span class="n">cumulative</span><span class="o">=</span><span class="n">cumulative</span><span class="p">,</span>
                                                              <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">,</span>
                                                              <span class="n">as_dataframe</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">id_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">bin_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>

        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">bin_data</span><span class="p">[</span><span class="n">variables</span><span class="p">]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="c1"># convert the interval to the left edge TODO: make flexible</span>
        <span class="n">df</span><span class="p">[</span><span class="n">id_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">id_var</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="n">var_cutoff</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">id_var</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_bins&#39;</span><span class="p">,</span> <span class="s1">&#39;_cut-off&#39;</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">id_var</span><span class="p">:</span> <span class="n">var_cutoff</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="n">var_cutoff</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;component&#39;</span><span class="p">)</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">var_cutoff</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">facet_row</span><span class="o">=</span><span class="s1">&#39;component&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="MassComposition.plot_intervals"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.plot_intervals">[docs]</a>    <span class="k">def</span> <span class="nf">plot_intervals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                       <span class="n">cumulative</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">direction</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;descending&#39;</span><span class="p">,</span>
                       <span class="n">show_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">min_x</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot &quot;The Grade-Tonnage&quot; curve.</span>

<span class="sd">        Mass and grade by bins for a cut-off variable.</span>

<span class="sd">        Args:</span>
<span class="sd">            variables: List of variables to include in the plot</span>
<span class="sd">            cumulative: If True, the results are cumulative weight averaged.</span>
<span class="sd">            direction: &#39;ascending&#39;|&#39;descending&#39;, if cumulative is True, the direction of accumulation</span>
<span class="sd">            show_edges: If True, show the edges on the plot.  Applicable to cumulative plots only.</span>
<span class="sd">            min_x: Optional minimum value for the x-axis, useful to set reasonable visual range with a log</span>
<span class="sd">            scaled x-axis when plotting size data</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>

        <span class="n">plot_kwargs</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">line_shape</span><span class="o">=</span><span class="s1">&#39;vh&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cumulative</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">data</span><span class="p">()</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">cumulate</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">)</span>
            <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">line_shape</span><span class="o">=</span><span class="s1">&#39;spline&#39;</span><span class="p">)</span>

        <span class="n">interval_data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

        <span class="n">df_intervals</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intervals_to_columns</span><span class="p">(</span><span class="n">interval_index</span><span class="o">=</span><span class="n">interval_data</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_intervals</span><span class="p">,</span> <span class="n">interval_data</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
        <span class="n">x_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">interval_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cumulative</span><span class="p">:</span>
            <span class="c1"># append on the largest fraction right edge for display purposes</span>
            <span class="n">df_end</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_intervals</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">+</span> <span class="n">variables</span><span class="p">]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="n">df_end</span><span class="p">[</span><span class="n">df_intervals</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">df_end</span><span class="p">[</span><span class="n">df_intervals</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">df_end</span><span class="p">[</span><span class="n">df_intervals</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_end</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
            <span class="n">df</span><span class="p">[</span><span class="n">interval_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df_intervals</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;ascending&#39;</span><span class="p">:</span>
                <span class="n">x_var</span> <span class="o">=</span> <span class="n">df_intervals</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;descending&#39;</span><span class="p">:</span>
                <span class="n">x_var</span> <span class="o">=</span> <span class="n">df_intervals</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="s1">&#39;size&#39;</span> <span class="ow">in</span> <span class="n">x_var</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">min_x</span><span class="p">:</span>
                <span class="n">min_x</span> <span class="o">=</span> <span class="n">interval_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">right</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="c1"># set zero to the minimum x value (for display only) to enable the tooltips on that point.</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">x_var</span><span class="p">]</span> <span class="o">==</span> <span class="n">df</span><span class="p">[</span><span class="n">x_var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">x_var</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_x</span>
            <span class="n">hover_data</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;component&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># add other column, default formatting</span>
                          <span class="n">x_var</span><span class="p">:</span> <span class="s1">&#39;:.3f&#39;</span><span class="p">,</span>  <span class="c1"># add other column, customized formatting</span>
                          <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;:.2f&#39;</span>
                          <span class="p">}</span>
            <span class="n">plot_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">plot_kwargs</span><span class="p">,</span>
                           <span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">log_x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">range_x</span><span class="o">=</span><span class="p">[</span><span class="n">min_x</span><span class="p">,</span> <span class="n">interval_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">right</span><span class="p">],</span>
                                  <span class="n">hover_data</span><span class="o">=</span><span class="n">hover_data</span><span class="p">)}</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span><span class="n">x_var</span><span class="p">]</span> <span class="o">+</span> <span class="n">variables</span><span class="p">]</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="p">[</span><span class="n">x_var</span><span class="p">],</span> <span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;component&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cumulative</span> <span class="ow">and</span> <span class="n">show_edges</span><span class="p">:</span>
            <span class="n">plot_kwargs</span><span class="p">[</span><span class="s1">&#39;markers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x_var</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">facet_row</span><span class="o">=</span><span class="s1">&#39;component&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">plot_kwargs</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">for_each_annotation</span><span class="p">(</span><span class="k">lambda</span> <span class="n">a</span><span class="p">:</span> <span class="n">a</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">a</span><span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;component=&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_yaxes</span><span class="p">(</span><span class="n">matches</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="MassComposition.plot_grade_recovery"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.plot_grade_recovery">[docs]</a>    <span class="k">def</span> <span class="nf">plot_grade_recovery</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_analyte</span><span class="p">,</span>
                            <span class="n">discard_from</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;lowest&quot;</span><span class="p">,</span> <span class="s2">&quot;highest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lowest&quot;</span><span class="p">,</span>
                            <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The grade-recovery plot.</span>

<span class="sd">        The grade recovery curve is generated by assuming an ideal separation (for the chosen property, or dimension)</span>
<span class="sd">        at each fractional interval.  It defines the theoretical maximum performance, which can only be improved if</span>
<span class="sd">        liberation is improved by comminution.</span>

<span class="sd">        This method is only applicable to a 1D object where the single dimension is a pd.Interval type.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_analyte: The analyte of value.</span>
<span class="sd">            discard_from: Defines the discarded direction.  discard_from = &quot;lowest&quot; will discard the lowest value</span>
<span class="sd">             first, then the next lowest, etc.</span>
<span class="sd">            title: Optional plot title</span>

<span class="sd">        Returns:</span>
<span class="sd">            A plotly.GraphObjects figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;Ideal Grade - Recovery&#39;</span>

        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideal_incremental_separation</span><span class="p">(</span><span class="n">discard_from</span><span class="o">=</span><span class="n">discard_from</span><span class="p">)</span>
        <span class="n">df_recovery</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;recovery&#39;</span><span class="p">),</span> <span class="p">[</span><span class="n">target_analyte</span><span class="p">,</span> <span class="s1">&#39;mass_dry&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span>
            <span class="s1">&#39;attribute&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;mass_dry&#39;</span><span class="p">:</span> <span class="s1">&#39;Yield&#39;</span><span class="p">,</span> <span class="n">target_analyte</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_analyte</span><span class="si">}</span><span class="s2">_recovery&quot;</span><span class="p">})</span>
        <span class="n">df_composition</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="nb">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span> <span class="s1">&#39;composition&#39;</span><span class="p">),</span> <span class="p">:]</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="s1">&#39;attribute&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mass_wet&#39;</span><span class="p">,</span> <span class="s1">&#39;mass_dry&#39;</span><span class="p">,</span> <span class="s1">&#39;H2O&#39;</span><span class="p">])</span>

        <span class="n">df_plot</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_recovery</span><span class="p">,</span> <span class="n">df_composition</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">line</span><span class="p">(</span><span class="n">df_plot</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">target_analyte</span><span class="p">,</span>
                      <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">target_analyte</span><span class="si">}</span><span class="s2">_recovery&quot;</span><span class="p">,</span>
                      <span class="n">hover_data</span><span class="o">=</span><span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                      <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="c1"># fig.update_layout(xaxis_title=f&quot;Grade of {target_analyte}&quot;, yaxis_title=f&quot;Recovery of {target_analyte}&quot;,</span>
        <span class="c1">#                   title=title)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="MassComposition.plot_amenability"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.plot_amenability">[docs]</a>    <span class="k">def</span> <span class="nf">plot_amenability</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_analyte</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">discard_from</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;lowest&quot;</span><span class="p">,</span> <span class="s2">&quot;highest&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;lowest&quot;</span><span class="p">,</span>
                         <span class="n">gangue_analytes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The yield-recovery plot.</span>

<span class="sd">        The yield recovery curve provides an understanding of the amenability of a sample.</span>

<span class="sd">        This method is only applicable to a 1D object where the single dimension is a pd.Interval type.</span>

<span class="sd">        Args:</span>
<span class="sd">            target_analyte: The analyte of value.</span>
<span class="sd">            discard_from: Defines the discarded direction.  discard_from = &quot;lowest&quot; will discard the lowest value</span>
<span class="sd">             first, then the next lowest, etc.</span>
<span class="sd">            gangue_analytes: The analytes to be rejected</span>
<span class="sd">            title: Optional plot title</span>

<span class="sd">        Returns:</span>
<span class="sd">            A plotly.GraphObjects figure</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">title</span> <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s1">&#39;Amenability Plot&#39;</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ideal_incremental_recovery</span><span class="p">(</span><span class="n">discard_from</span><span class="o">=</span><span class="n">discard_from</span><span class="p">)</span>
        <span class="n">amenability_indices</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span> <span class="o">=</span> <span class="n">amenability_index</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col_target</span><span class="o">=</span><span class="n">target_analyte</span><span class="p">,</span> <span class="n">col_mass_recovery</span><span class="o">=</span><span class="s1">&#39;mass&#39;</span><span class="p">)</span>

        <span class="n">analytes</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;mass&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="n">gangue_analytes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">[</span>
            <span class="n">target_analyte</span> <span class="o">+</span> <span class="n">gangue_analytes</span><span class="p">]</span>

        <span class="n">mass_rec</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;mass&quot;</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">analytes</span><span class="p">]</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">analyte</span> <span class="ow">in</span> <span class="n">analytes</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">mass_rec</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">df</span><span class="p">[</span><span class="n">analyte</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                           <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">analyte</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">round</span><span class="p">(</span><span class="n">amenability_indices</span><span class="p">[</span><span class="n">analyte</span><span class="p">],</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">,</span>
                           <span class="n">customdata</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                           <span class="n">hovertemplate</span><span class="o">=</span><span class="s1">&#39;&lt;b&gt;Recovery: %</span><span class="si">{y:.3f}</span><span class="s1">&lt;/b&gt;&lt;br&gt;Cut-point: %</span><span class="si">{customdata:.3f}</span><span class="s1"> &#39;</span><span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span><span class="n">go</span><span class="o">.</span><span class="n">Scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;y=x&#39;</span><span class="p">,</span>
                                 <span class="n">line</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">dash</span><span class="o">=</span><span class="s1">&#39;dash&#39;</span><span class="p">),</span>
                                 <span class="p">))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">xaxis_title</span><span class="o">=</span><span class="s1">&#39;Yield (Mass Recovery)&#39;</span><span class="p">,</span> <span class="n">yaxis_title</span><span class="o">=</span><span class="s1">&#39;Recovery&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                          <span class="n">hovermode</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="MassComposition.plot_parallel"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.plot_parallel">[docs]</a>    <span class="k">def</span> <span class="nf">plot_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">vars_include</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">vars_exclude</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">include_dims</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">bool</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                      <span class="n">plot_interval_edges</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an interactive parallel plot</span>

<span class="sd">        Useful to explore multidimensional data like mass-composition data</span>

<span class="sd">        Args:</span>
<span class="sd">            color: Optional color variable</span>
<span class="sd">            vars_include: Optional List of variables to include in the plot</span>
<span class="sd">            vars_exclude: Optional List of variables to exclude in the plot</span>
<span class="sd">            title: Optional plot title</span>
<span class="sd">            include_dims: Optional boolean or list of dimension to include in the plot.  True will show all dims.</span>
<span class="sd">            plot_interval_edges: If True, interval edges will be plotted instead of interval mid</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">parallel_plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">vars_include</span><span class="o">=</span><span class="n">vars_include</span><span class="p">,</span> <span class="n">vars_exclude</span><span class="o">=</span><span class="n">vars_exclude</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                            <span class="n">include_dims</span><span class="o">=</span><span class="n">include_dims</span><span class="p">,</span> <span class="n">plot_interval_edges</span><span class="o">=</span><span class="n">plot_interval_edges</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="MassComposition.plot_comparison"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.plot_comparison">[docs]</a>    <span class="k">def</span> <span class="nf">plot_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">,</span>
                        <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">vars_include</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">vars_exclude</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">facet_col_wrap</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
                        <span class="n">trendline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="n">trendline_kwargs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                        <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an interactive parallel plot</span>

<span class="sd">        Useful to compare the difference in component values between two objects.</span>

<span class="sd">        Args:</span>
<span class="sd">            other: the object to compare with self.</span>
<span class="sd">            color: Optional color variable</span>
<span class="sd">            vars_include: Optional List of variables to include in the plot</span>
<span class="sd">            vars_exclude: Optional List of variables to exclude in the plot</span>
<span class="sd">            trendline: If True and trendlines</span>
<span class="sd">            trendline_kwargs: Allows customising the trendline: ref: https://plotly.com/python/linear-fits/</span>
<span class="sd">            title: Optional plot title</span>
<span class="sd">            facet_col_wrap: The number of subplot columns per row.</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df_self</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="n">df_other</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">vars_include</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">missing_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">vars_include</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">df_self</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_vars</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;var_subset provided contains variable not found in the data: </span><span class="si">{</span><span class="n">missing_vars</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">df_self</span> <span class="o">=</span> <span class="n">df_self</span><span class="p">[</span><span class="n">vars_include</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vars_exclude</span><span class="p">:</span>
            <span class="n">df_self</span> <span class="o">=</span> <span class="n">df_self</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_self</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">vars_exclude</span><span class="p">]]</span>
        <span class="n">df_other</span> <span class="o">=</span> <span class="n">df_other</span><span class="p">[</span><span class="n">df_self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="c1"># Supplementary variables are the same for each stream and so will be unstacked.</span>
        <span class="n">supp_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df_self</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">supplementary</span><span class="o">.</span><span class="n">get_col_names</span><span class="p">()]</span>
        <span class="k">if</span> <span class="n">supp_cols</span><span class="p">:</span>
            <span class="n">df_self</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">supp_cols</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">df_other</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">supp_cols</span><span class="p">,</span> <span class="n">append</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">index_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_self</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">df_self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">df_self</span> <span class="o">=</span> <span class="n">df_self</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">index_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">df_other</span> <span class="o">=</span> <span class="n">df_other</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="n">index_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

        <span class="n">df_plot</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_self</span><span class="p">,</span> <span class="n">df_other</span><span class="p">])</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">index_names</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">unstack</span><span class="p">([</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">droplevel</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">df_plot</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">index_names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># set variables back to standard order</span>
        <span class="n">variable_order</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cols</span><span class="p">)}</span>
        <span class="n">df_plot</span> <span class="o">=</span> <span class="n">df_plot</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">variable_order</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">:</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span> <span class="o">=</span> <span class="n">comparison_plot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_plot</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">facet_col_wrap</span><span class="o">=</span><span class="n">facet_col_wrap</span><span class="p">,</span>
                                         <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">trendline</span><span class="o">=</span><span class="n">trendline</span><span class="p">,</span> <span class="n">trendline_kwargs</span><span class="o">=</span><span class="n">trendline_kwargs</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="MassComposition.plot_ternary"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.plot_ternary">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ternary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">color</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">title</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">go</span><span class="o">.</span><span class="n">Figure</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Plot a ternary diagram</span>

<span class="sd">            variables: List of 3 components to plot</span>
<span class="sd">            color: Optional color variable</span>
<span class="sd">            title: Optional plot title</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="n">vars_missing</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">variables</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">vars_missing</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Variable/s not found in the dataset: </span><span class="si">{</span><span class="n">vars_missing</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">variables</span>
        <span class="k">if</span> <span class="n">color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">color</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_ternary</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">a</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">scatter_ternary</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cols</span><span class="p">],</span> <span class="n">a</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">b</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">c</span><span class="o">=</span><span class="n">variables</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">update_layout</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">res</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
        <span class="n">res</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">res</span>

<div class="viewcode-block" id="MassComposition.__add__"><a class="viewcode-back" href="../../../api/_autosummary/elphick.mass_composition.mass_composition.MassComposition.html#elphick.mass_composition.mass_composition.MassComposition.__add__">[docs]</a>    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add two objects</span>

<span class="sd">        Perform the addition with the mass-composition variables only and then append any attribute variables.</span>
<span class="sd">        Presently ignores any attribute vars in other</span>
<span class="sd">        Args:</span>
<span class="sd">            other: object to add to self</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">xr_sum</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="n">MassComposition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">xr_sum</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">xr_sum</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>

        <span class="n">other</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">res</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">random_int</span><span class="p">()]</span>

        <span class="k">return</span> <span class="n">res</span></div>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Subtract the supplied object from self</span>

<span class="sd">        Perform the subtraction with the mass-composition variables only and then append any attribute variables.</span>
<span class="sd">        Args:</span>
<span class="sd">            other: object to subtract from self</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xr_sub</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="n">MassComposition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">xr_sub</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">xr_sub</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>

        <span class="n">res</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">random_int</span><span class="p">()]</span>
        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;MassComposition&#39;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Divide self by the supplied object</span>

<span class="sd">        Perform the division with the mass-composition variables only and then append any attribute variables.</span>
<span class="sd">        Args:</span>
<span class="sd">            other: denominator object, self will be divided by this object</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">xr_div</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">div</span><span class="p">(</span><span class="n">other</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">MassComposition</span> <span class="o">=</span> <span class="n">MassComposition</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">xr_div</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="n">res</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">xr_div</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">res</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">MassComposition</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_cols_in_data_cols</span><span class="p">(</span><span class="n">cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">cols_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cols_data</span><span class="p">):</span>
                <span class="n">msg</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2"> not in the data columns: </span><span class="si">{</span><span class="n">cols_data</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_copy_all_attrs</span><span class="p">(</span><span class="n">xr_to</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">xr_from</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
        <span class="n">xr_to</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">xr_from</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">da</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span>
        <span class="k">for</span> <span class="n">new_da</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xr_to</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">xr_from</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="n">new_da</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">da</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">xr_to</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_clip</span><span class="p">(</span><span class="n">xr_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">variables</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">limits</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">variables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">variables</span> <span class="o">=</span> <span class="n">variables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">xr_ds</span><span class="p">[</span><span class="n">variables</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr_ds</span><span class="p">[</span><span class="n">variables</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xr_ds</span><span class="p">[</span><span class="n">variables</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xr_ds</span><span class="p">[</span><span class="n">variables</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr_ds</span><span class="p">[</span><span class="n">variables</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">xr_ds</span><span class="p">[</span><span class="n">variables</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">xr_ds</span>

    <span class="k">def</span> <span class="nf">_post_process_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj_1</span><span class="p">,</span> <span class="n">obj_2</span><span class="p">,</span> <span class="n">name_1</span><span class="p">,</span> <span class="n">name_2</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">name_1</span><span class="p">:</span>
            <span class="n">obj_1</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name_1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">name_2</span><span class="p">:</span>
            <span class="n">obj_2</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">mc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">name_2</span><span class="p">)</span>
        <span class="n">obj_1</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">random_int</span><span class="p">()]</span>
        <span class="n">obj_2</span><span class="o">.</span><span class="n">_nodes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_nodes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">random_int</span><span class="p">()]</span>
        <span class="n">obj_1</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name_1</span>
        <span class="n">obj_2</span><span class="o">.</span><span class="n">_name</span> <span class="o">=</span> <span class="n">name_2</span>

        <span class="k">return</span> <span class="n">obj_1</span><span class="p">,</span> <span class="n">obj_2</span>

    <span class="k">def</span> <span class="nf">_intervals_to_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interval_index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">IntervalIndex</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reconstruct columns from an interval index</span>

<span class="sd">        Uses the left and right names stored in the xr.Dataset attrs</span>

<span class="sd">        Args:</span>
<span class="sd">            interval_index: The IntervalIndex to convert to named columns of edges</span>

<span class="sd">        Returns:</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">base_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">interval_index</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mc_interval_edges&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">d_edge_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;mc_interval_edges&#39;</span><span class="p">][</span><span class="n">base_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d_edge_names</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="s1">&#39;right&#39;</span><span class="p">}</span>
        <span class="n">df_intervals</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">interval_index</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df_intervals</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">d_edge_names</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_intervals</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">left</span><span class="p">)</span>
        <span class="n">df_intervals</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">base_name</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">d_edge_names</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_intervals</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">right</span><span class="p">)</span>
        <span class="n">df_intervals</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">df_intervals</span>

    <span class="k">def</span> <span class="nf">_create_interval_indexes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">][</span><span class="s1">&#39;suffixes&#39;</span><span class="p">]:</span>
                <span class="n">suffix_candidates</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="n">n</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span><span class="p">}</span>
                <span class="n">suffixes</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">suffix_candidates</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">}</span>
                <span class="k">if</span> <span class="n">suffixes</span><span class="p">:</span>
                    <span class="n">indexes_orig</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">names</span>
                    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                    <span class="n">num_intervals</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">suffixes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_intervals</span><span class="p">):</span>
                        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">suffixes</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                        <span class="n">base_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">data</span><span class="p">[</span><span class="n">base_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">arrays</span><span class="o">.</span><span class="n">IntervalArray</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">right</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                                                              <span class="n">closed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;intervals&#39;</span><span class="p">][</span><span class="s1">&#39;closed&#39;</span><span class="p">])</span>
                        <span class="c1"># verbose but need to preserve index order...</span>
                        <span class="n">new_indexes</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">index_edge_names</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">base_name</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;left&#39;</span><span class="p">:</span> <span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                                                              <span class="s1">&#39;right&#39;</span><span class="p">:</span> <span class="n">keys</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]}}</span>
                        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexes_orig</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">index</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
                                <span class="n">new_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">base_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_indexes</span><span class="p">):</span>
                                <span class="n">new_indexes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>

                        <span class="c1"># push the left and right names (suffixes) to the dataset attrs</span>
                        <span class="c1"># (series attrs are lost when set to an index)</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">index_edge_names</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">new_indexes</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_solve_mass_moisture</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>

        <span class="n">d_var_map</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">mass_moisture</span><span class="o">.</span><span class="n">property_to_var</span><span class="p">()</span>
        <span class="n">d_var_exists</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d_var_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">d_mass_var_exists</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">property_to_var</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d_var_exists</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Insufficient data supplied to solve mass-moisture: </span><span class="si">{</span><span class="n">d_var_exists</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d_mass_var_exists</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;At least one mass variable must be supplied to solve mass-moisture: </span><span class="si">{</span><span class="n">d_mass_var_exists</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d_var_exists</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="c1"># TODO: add mass-moisture balance integrity check.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s1">&#39;The mass-moisture variables are over-specified and not (yet) checked for balance. &#39;</span>
                <span class="s1">&#39;Moisture is ignored and the mass variables assumed to be correct.&#39;</span><span class="p">)</span>

        <span class="c1"># assume zero moisture</span>
        <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">d_var_exists</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">d_var_map</span><span class="p">[</span><span class="s1">&#39;moisture&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Zero moisture has been assumed.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">d_var_exists</span><span class="p">[</span><span class="s1">&#39;mass_wet&#39;</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">d_var_map</span><span class="p">[</span><span class="s1">&#39;mass_wet&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">solve_mass_moisture</span><span class="p">(</span><span class="n">mass_dry</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">d_var_map</span><span class="p">[</span><span class="s1">&#39;mass_dry&#39;</span><span class="p">]],</span>
                                                              <span class="n">moisture</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">d_var_map</span><span class="p">[</span><span class="s1">&#39;moisture&#39;</span><span class="p">]])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">d_var_exists</span><span class="p">[</span><span class="s1">&#39;mass_dry&#39;</span><span class="p">]:</span>
            <span class="n">data</span><span class="p">[</span><span class="n">d_var_map</span><span class="p">[</span><span class="s1">&#39;mass_dry&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">solve_mass_moisture</span><span class="p">(</span><span class="n">mass_wet</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">d_var_map</span><span class="p">[</span><span class="s1">&#39;mass_wet&#39;</span><span class="p">]],</span>
                                                              <span class="n">moisture</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="n">d_var_map</span><span class="p">[</span><span class="s1">&#39;moisture&#39;</span><span class="p">]])</span>

        <span class="c1"># drop the moisture column, since it is now redundant, work with mass, moisture is dependent property</span>
        <span class="k">if</span> <span class="n">d_var_exists</span><span class="p">[</span><span class="s1">&#39;moisture&#39;</span><span class="p">]:</span>
            <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">d_var_map</span><span class="p">[</span><span class="s1">&#39;moisture&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">_dataframe_to_mc_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="c1"># create the xr.Dataset, dims from the index.</span>
        <span class="n">xr_ds</span><span class="p">:</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">to_xarray</span><span class="p">()</span>
        <span class="c1"># move the attrs to become coords - HOLD - this creates merging problems in the data property, reconsider.</span>
        <span class="c1"># xr_ds = xr_ds.set_coords(cols_attrs)</span>
        <span class="c1"># add the dataset attributes</span>
        <span class="n">ds_attrs</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;mc_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name</span><span class="p">,</span>
                          <span class="s1">&#39;mc_vars_mass&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">get_var_names</span><span class="p">(),</span>
                          <span class="s1">&#39;mc_vars_chem&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">chemistry</span><span class="o">.</span><span class="n">get_var_names</span><span class="p">(),</span>
                          <span class="s1">&#39;mc_vars_attrs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">supplementary</span><span class="o">.</span><span class="n">get_var_names</span><span class="p">(),</span>
                          <span class="s1">&#39;mc_interval_edges&#39;</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">attrs</span><span class="p">}</span>
        <span class="n">xr_ds</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">ds_attrs</span>
        <span class="c1"># add the variable attributes</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">xr</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="n">xr_ds</span><span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;units&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mass_units</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="n">VariableGroups</span><span class="o">.</span><span class="n">MASS</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_composition_units</span><span class="p">,</span>
                <span class="s1">&#39;standard_name&#39;</span><span class="p">:</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">title</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="n">VariableGroups</span><span class="o">.</span><span class="n">MASS</span> <span class="k">else</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s1">&#39;mc_type&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">VariableGroups</span><span class="o">.</span><span class="n">MASS</span> <span class="k">if</span> <span class="n">v</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="n">VariableGroups</span><span class="o">.</span><span class="n">MASS</span> <span class="k">else</span> <span class="n">VariableGroups</span><span class="o">.</span><span class="n">CHEMISTRY</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                <span class="s1">&#39;mc_col_orig&#39;</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">column_name</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">xr_ds</span>

    <span class="k">def</span> <span class="nf">_check_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Determine if all records are within the constraints&quot;&quot;&quot;</span>
        <span class="c1"># execute column-wise to manage memory</span>
        <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">variable</span><span class="p">,</span> <span class="n">bounds</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">chunks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">variable</span><span class="p">])</span>
        <span class="n">oor</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">chunks</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s1">&#39;columns&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">oor</span>

    <span class="k">def</span> <span class="nf">_check_one_dim_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This object is </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span><span class="si">}</span><span class="s2"> dimensional. &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot;Only 1D interval objects are valid&quot;</span><span class="p">)</span>
        <span class="n">index_var</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">index_var</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">Interval</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The dim </span><span class="si">{</span><span class="n">index_var</span><span class="si">}</span><span class="s2"> of this object is not a pd.Interval. &quot;</span>
                                      <span class="sa">f</span><span class="s2">&quot; Only 1D interval objects are valid&quot;</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Greg Elphick.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>